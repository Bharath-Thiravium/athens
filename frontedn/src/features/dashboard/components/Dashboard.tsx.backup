
// src/features/dashboard/components/Dashboard.tsx

import React, { useState, useEffect } from 'react';
import {
    Layout, Menu, Button, Avatar, Typography, Dropdown, Space,
    Modal, App, Badge, Card, Divider, Tag, Spin
} from 'antd';
import type { MenuProps } from 'antd';
import {
    MenuUnfoldOutlined, MenuFoldOutlined, UserOutlined, DashboardOutlined, ProjectOutlined,
    TeamOutlined, SettingOutlined, LogoutOutlined, BellOutlined, MessageOutlined, BookOutlined,
    ReadOutlined, FileTextOutlined, SafetyOutlined, FormOutlined, PlusOutlined, ClockCircleOutlined,
    BarChartOutlined, SunOutlined, MoonOutlined, DesktopOutlined, AuditOutlined, RocketOutlined,
    ApartmentOutlined, DeleteOutlined, ArrowRightOutlined, CheckCircleOutlined, ExperimentOutlined
} from '@ant-design/icons';
import { useNavigate, Outlet, useLocation } from 'react-router-dom';
import axios from 'axios';
import useAuthStore from '@common/store/authStore';

import api from '@common/utils/axiosetup';
import { useNotificationsContext } from '@common/contexts/NotificationsContext';
import { useTheme } from '@common/contexts/ThemeContext';
import type { Notification } from '@common/utils/webSocketNotificationService';
import UserDetail from '@features/user/components/userdetail';
import DashboardOverview from './DashboardOverview';
import { getMenuItemsForUser } from '../config/menuConfig';
// No need to import ProjectAttendance here anymore, it's handled by the router
// import ProjectAttendance from '@features/project/components/ProjectAttendance';

type MenuItem = Required<MenuProps>['items'][number];

const { Header, Sider, Content } = Layout;
const { Title, Text, Paragraph } = Typography;

const Dashboard: React.FC = () => {
    const { message } = App.useApp();

    // =============================================================================
    // STATE, HOOKS, AND LOGIC (Your existing code, unchanged)
    // =============================================================================
    const { theme, setTheme, effectiveTheme } = useTheme();
    const [collapsed, setCollapsed] = useState(window.innerWidth < 1024);
    const [pendingUsers, setPendingUsers] = useState<any[]>([]);
    const [userToApprove, setUserToApprove] = useState<any | null>(null);
    const [adminToApprove, setAdminToApprove] = useState<any | null>(null);
    const [companyLogoUrl, setCompanyLogoUrl] = useState<string | null>(null);
    const [companyName, setCompanyName] = useState<string>('YourBrand');
    const [meetingInvitationModalVisible, setMeetingInvitationModalVisible] = useState(false);
    const [currentMeetingInvitation, setCurrentMeetingInvitation] = useState<{ momId: any; userId: any; title: any; notificationId: any; } | null>(null);
    const [meetingModalLoading, setMeetingModalLoading] = useState(false);
    const [notificationModal, setNotificationModal] = useState<{visible: boolean, notification?: Notification}>({visible: false});
    const [userMobile, setUserMobile] = useState<string>('');
    const [isLoggingOut, setIsLoggingOut] = useState(false);

    const { notifications, unreadCount, markAsRead, markAllAsRead, deleteNotification, sendApprovalNotification } = useNotificationsContext();
    const navigate = useNavigate();
    const location = useLocation();
    const { clearToken, username, usertype, django_user_type } = useAuthStore();


    const getSelectedKey = () => location.pathname;
    const [selectedKey, setSelectedKey] = useState<string>(getSelectedKey());
    useEffect(() => { setSelectedKey(getSelectedKey()); }, [location]);

    const handleLogout = async () => {
        try {
          // Set loading state IMMEDIATELY to prevent dashboard flash
          setIsLoggingOut(true);

          // Get tokens before clearing
          const { token, refreshToken } = useAuthStore.getState();

          // IMMEDIATE navigation to prevent unauthorized user flash
          navigate('/login', { replace: true });

          // Make logout API call if we have tokens
          if (token && refreshToken) {
            try {
              await api.post('/authentication/logout/',
                { refresh: refreshToken },
                {
                  headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                  },
                  timeout: 10000
                }
              );
            } catch (apiError: any) {
              // Continue with local logout even if API fails
            }
          }

          // Clear tokens AFTER navigation starts
          clearToken();

          // Show success message
          try {
            message.success('Logged out successfully');
          } catch (msgError) {
            // Message failed to show
          }

        } catch (error) {
          // Fallback: ensure user is logged out locally
          clearToken();
          message.success('Logged out successfully');
          setTimeout(() => {
            navigate('/login', { replace: true });
          }, 100);
        } finally {
          setIsLoggingOut(false);
        }
    };

    const handleUserMenuClick = (e: any) => {
        if (e.key === '/dashboard/profile') navigate('/dashboard/profile');
        else if (e.key === '/dashboard/settings') navigate('/dashboard/settings');
        else if (e.key === 'logout') handleLogout();
    };

    const handleMenuClick = (e: any) => navigate(e.key);

    const getMenuItems = (): MenuItem[] => {
        // Use centralized menu configuration
        return getMenuItemsForUser(usertype || undefined, django_user_type || undefined);
    };



    const handleApprovalSuccess = async (approvedUserId: number) => {
        setPendingUsers(pendingUsers.filter((user) => user.id !== approvedUserId));
        setUserToApprove(null);
        try {
          await sendApprovalNotification(approvedUserId, { title: 'Your Details Approved', message: 'Your user details have been approved by the administrator.', formType: 'userdetail', itemId: approvedUserId });
          message.success('User approved successfully and notification sent.');
        } catch (error) {
          message.success('User approved successfully.');
        }
    };

    const handleAdminApprovalSuccess = async (_approvedAdminId: number) => {
        setAdminToApprove(null);
        // Backend already sends notification, no need to send from frontend
        message.success('Admin approved successfully.');
    };

    const handleNotificationClick = async (notification: Notification) => {
        try {
            // Notification clicked - processing

            if (!notification.read) await markAsRead(notification.id);
            setNotificationModal({ visible: true, notification });
            if (notification.type === 'meeting_invitation' && notification.data && typeof notification.data === 'object' && 'momId' in notification.data) {
                setCurrentMeetingInvitation({ momId: notification.data.momId, userId: notification.data.userId, title: notification.data.title || 'a meeting', notificationId: notification.id, });
                setMeetingInvitationModalVisible(true);
            }
        } catch (error) {
            message.error("Could not process notification.");
        }
    };

    const handleMarkAllAsRead = async () => {
        await markAllAsRead();
        message.success('All notifications marked as read');
    };

    const handleMeetingResponse = async (status: 'accepted' | 'rejected') => {
        if (!currentMeetingInvitation) return;
        const { momId, userId } = currentMeetingInvitation;
        setMeetingModalLoading(true);
        try {
            await api.post(`/api/v1/mom/${momId}/participants/${userId}/response/`, { status });
            message.success(`You have ${status} the meeting invitation.`);
            setMeetingInvitationModalVisible(false);
            setCurrentMeetingInvitation(null);
        } catch (err) {
            message.error('Failed to send your response.');
        } finally {
            setMeetingModalLoading(false);
        }
    };

    useEffect(() => {
        const fetchCompanyDetails = async () => {
          // Load cached values first for immediate display
          const cacheKey = `company_data_${username}_${usertype}`;
          const cachedData = localStorage.getItem(cacheKey);

          if (cachedData) {
            try {
              const parsed = JSON.parse(cachedData);
              if (parsed.company_logo) setCompanyLogoUrl(parsed.company_logo);
              if (parsed.company_name) setCompanyName(parsed.company_name);
              console.log('ðŸ“¦ Loaded cached company data:', parsed);
            } catch (e) {
              console.warn('âš ï¸ Failed to parse cached company data');
            }
          }

          try {
            // Use unified endpoint for all user types
            console.log('ðŸ“¡ Fetching company data for user:', { usertype, username });
            const response = await api.get('/authentication/company-data/');
            console.log('âœ… Loaded unified company data:', response.data);
            console.log('ðŸ” User type specific debug:', {
              usertype,
              isEPC: usertype === 'epc',
              isMaster: usertype === 'master',
              responseSuccess: response.data.success,
              hasLogo: !!response.data.company_logo,
              logoValue: response.data.company_logo
            });

            if (response.data.success) {
              const data = response.data;

              // Update logo
              if (data.company_logo) {
                // Convert relative URL to absolute URL
                let logoUrl = data.company_logo;
                if (logoUrl.startsWith('/media/')) {
                  logoUrl = `${import.meta.env.VITE_API_BASE_URL || 'http://localhost:8000'}${logoUrl}`;
                }
                setCompanyLogoUrl(logoUrl);
                console.log('ðŸ–¼ï¸ Updated company logo (original):', data.company_logo);
                console.log('ðŸ–¼ï¸ Updated company logo (absolute):', logoUrl);
              } else {
                setCompanyLogoUrl(null);
                console.log('ðŸ–¼ï¸ No company logo available');
              }

              // Update company name
              if (data.company_name) {
                setCompanyName(data.company_name);
                console.log('ðŸ¢ Updated company name:', data.company_name);
              } else {
                setCompanyName('YourBrand');
                console.log('ðŸ¢ Using default company name');
              }

              // Cache the data with user-specific key
              const cacheData = {
                company_logo: data.company_logo,
                company_name: data.company_name,
                timestamp: Date.now(),
                source: data.source
              };
              localStorage.setItem(cacheKey, JSON.stringify(cacheData));

              // Clean up old cache keys
              ['company_logo_url', 'company_name'].forEach(oldKey => {
                localStorage.removeItem(oldKey);
              });

              console.log('ðŸ’¾ Cached company data with key:', cacheKey);
            } else {
              console.log('âš ï¸ Unified endpoint returned success: false');
            }
          } catch (error) {
            console.error('âŒ Failed to fetch unified company data:', error);

            // Fallback to old endpoints if unified endpoint fails
            console.log('ðŸ”„ Trying fallback endpoints...');
            try {
              let fallbackResponse;

              if (usertype === 'master') {
                fallbackResponse = await api.get('/authentication/companydetail/');
                console.log('ðŸ“¦ Fallback: Loaded company details for master:', fallbackResponse.data);
              } else {
                fallbackResponse = await api.get('/authentication/admin/me/');
                console.log('ðŸ“¦ Fallback: Loaded admin details:', fallbackResponse.data);
              }

              if (fallbackResponse?.data) {
                const data = fallbackResponse.data;
                const logoUrl = data.company_logo || data.logo_url;
                const companyName = data.company_name;

                if (logoUrl) {
                  setCompanyLogoUrl(logoUrl);
                  console.log('ðŸ–¼ï¸ Fallback: Updated company logo:', logoUrl);
                }

                if (companyName) {
                  setCompanyName(companyName);
                  console.log('ðŸ¢ Fallback: Updated company name:', companyName);
                }
              }
            } catch (fallbackError) {
              console.error('âŒ Fallback endpoints also failed:', fallbackError);
            }
          }
        };

        // Only fetch if we have user type information
        if (usertype && username) {
          fetchCompanyDetails();
        }
      }, [usertype, username]); // Add username as dependency for cache key

    // Separate useEffect for event listeners
    useEffect(() => {
        const handleCompanyDataUpdate = (event: CustomEvent) => {
          console.log('ðŸ”„ Company data update event received:', event.detail);

          if (event.detail) {
            // Update logo if provided
            if (event.detail.logoUrl || event.detail.company_logo) {
              let logoUrl = event.detail.logoUrl || event.detail.company_logo;
              // Convert relative URL to absolute URL
              if (logoUrl.startsWith('/media/')) {
                logoUrl = `${import.meta.env.VITE_API_BASE_URL || 'http://localhost:8000'}${logoUrl}`;
              }
              setCompanyLogoUrl(logoUrl);
              console.log('ðŸ”„ Logo updated via event (absolute):', logoUrl);
            }

            // Update company name if provided
            if (event.detail.companyName || event.detail.company_name) {
              const companyName = event.detail.companyName || event.detail.company_name;
              setCompanyName(companyName);
              console.log('ðŸ”„ Company name updated via event:', companyName);
            }

            // Update cache with new user-specific key
            if (username && usertype) {
              const cacheKey = `company_data_${username}_${usertype}`;
              const existingCache = localStorage.getItem(cacheKey);
              let cacheData: any = { timestamp: Date.now() };

              if (existingCache) {
                try {
                  cacheData = { ...JSON.parse(existingCache), timestamp: Date.now() };
                } catch (e) {
                  console.warn('âš ï¸ Failed to parse existing cache during update');
                }
              }

              // Update cache with new values
              if (event.detail.logoUrl || event.detail.company_logo) {
                cacheData.company_logo = event.detail.logoUrl || event.detail.company_logo;
              }
              if (event.detail.companyName || event.detail.company_name) {
                cacheData.company_name = event.detail.companyName || event.detail.company_name;
              }

              localStorage.setItem(cacheKey, JSON.stringify(cacheData));
              console.log('ðŸ’¾ Updated cache via event:', cacheKey);
            }
          }
        };

        // Listen for all company data update events
        const eventTypes = [
          'company_logo_updated',
          'company_name_updated',
          'admin_logo_updated',
          'admin_company_updated',
          'company_data_updated' // New unified event
        ];

        eventTypes.forEach(eventType => {
          window.addEventListener(eventType, handleCompanyDataUpdate as EventListener);
        });

        return () => {
          eventTypes.forEach(eventType => {
            window.removeEventListener(eventType, handleCompanyDataUpdate as EventListener);
          });
        };
    }, [username, usertype]); // Add dependencies for cache key

    useEffect(() => {
        const refreshTokenFunc = async () => { try { const m = await import('@common/utils/tokenrefresh'); await m.default(); } catch (err) { console.error('Token refresh failed:', err); } };
        refreshTokenFunc();
        const interval = setInterval(refreshTokenFunc, 10 * 60 * 1000);
        return () => clearInterval(interval);
    }, []);

    useEffect(() => {
        const handleResize = () => setCollapsed(window.innerWidth < 1024);
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
    }, []);

    useEffect(() => {
        const fetchUserData = async () => { if (django_user_type === 'adminuser') { try { const r = await api.get('/authentication/userdetail/'); if (r.data && r.data.mobile) setUserMobile(r.data.mobile); } catch (e) { console.error('Failed to fetch user data for profile:', e); } } };
        fetchUserData();
    }, [django_user_type]);

    // Show loading overlay during logout to prevent flash
    if (isLoggingOut) {
        return (
            <div className="fixed inset-0 bg-white dark:bg-gray-900 flex items-center justify-center z-50">
                <div className="text-center">
                    <Spin size="large" />
                    <div className="mt-4 text-lg text-gray-600 dark:text-gray-300">Logging out...</div>
                </div>
            </div>
        );
    }

    // Show loading screen during logout to prevent unauthorized flash
    if (isLoggingOut) {
        return (
            <div className="min-h-screen flex items-center justify-center bg-color-bg-base">
                <div className="text-center">
                    <Spin size="large" />
                    <div className="mt-4 text-color-text-base">Logging out...</div>
                </div>
            </div>
        );
    }

    return (
        <Layout className="dashboard-layout !bg-color-bg-base">
            <Sider
                collapsible
                collapsed={collapsed}
                width={250}
                collapsedWidth={88}
                trigger={null}
                theme={effectiveTheme}
                className="dashboard-sidebar !border-r !border-color-border flex flex-col !h-screen !overflow-hidden"
                style={{ height: '100vh', position: 'fixed', left: 0, top: 0, bottom: 0 }}
            >
                <div className="flex h-20 items-center gap-3 px-6 flex-shrink-0">
                    <div className="flex h-10 w-10 items-center justify-center rounded-lg bg-[linear-gradient(135deg,var(--gradient-start),var(--gradient-end))] flex-shrink-0">
                        {companyLogoUrl ? (
                          <img
                            src={companyLogoUrl}
                            alt="Logo"
                            className="h-full w-full object-contain p-1"
                            style={{
                              display: 'block',
                              width: '100%',
                              height: '100%',
                              minWidth: '32px',
                              minHeight: '32px',
                              maxWidth: '100%',
                              maxHeight: '100%'
                            }}
                            onError={(e) => {
                              // Silently handle logo load failure - fallback will be shown
                              console.warn('Logo failed to load, using fallback:', companyLogoUrl);
                              e.currentTarget.style.display = 'none';
                            }}
                            onLoad={(e) => {
                              console.log('âœ… Logo loaded successfully in sidebar:', companyLogoUrl);
                              console.log('âœ… Image element dimensions:', {
                                naturalWidth: e.currentTarget.naturalWidth,
                                naturalHeight: e.currentTarget.naturalHeight,
                                displayWidth: e.currentTarget.offsetWidth,
                                displayHeight: e.currentTarget.offsetHeight,
                                visible: e.currentTarget.offsetParent !== null
                              });
                            }}
                          />
                        ) : (
                          <ApartmentOutlined className="text-2xl text-white" />
                        )}
                    </div>
                    {!collapsed && <span className="font-bold text-xl text-color-text-base whitespace-nowrap">{companyName}</span>}
                </div>
                <div className="p-3 flex-shrink-0">
                    <div className="bg-color-bg-base p-4 rounded-lg">
                        <div className="flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <Avatar icon={<UserOutlined />} />
                                {!collapsed && <Text className="font-semibold text-color-text-base">{username || 'User'}</Text>}
                            </div>
                            {!collapsed && (
                                <div className="flex items-center bg-color-ui-base p-1 rounded-full shadow-inner">
                                    <Button shape="circle" size="small" icon={<SunOutlined />} onClick={() => setTheme('light')} className={effectiveTheme === 'light' ? '!bg-color-primary !text-white' : '!bg-transparent !border-none !text-color-text-muted'} />
                                    <Button shape="circle" size="small" icon={<MoonOutlined />} onClick={() => setTheme('dark')} className={effectiveTheme === 'dark' ? '!bg-color-primary !text-white' : '!bg-transparent !border-none !text-color-text-muted'} />
                                </div>
                            )}
                        </div>
                        {!collapsed && (
                            <div className="mt-4">
                                <Paragraph className="!mb-0 text-color-text-muted text-xs uppercase">{new Date().toLocaleDateString('en-US', { weekday: 'long' })}</Paragraph>
                                <Paragraph strong className="!mb-0 text-color-text-base text-lg">Welcome back,</Paragraph>
                            </div>
                        )}
                    </div>
                </div>
                <div className="flex-1 overflow-y-auto overflow-x-hidden min-h-0" style={{ maxHeight: 'calc(100vh - 220px)' }}>
                    <div className="p-3">
                        <Menu
                            mode="inline"
                            selectedKeys={[selectedKey]}
                            onClick={handleMenuClick}
                            className="!border-none !bg-transparent"
                            items={getMenuItems()}
                            style={{ height: 'auto', borderRight: 0 }}
                        />
                    </div>
                </div>
                {!collapsed && (
                    <div className="p-4 flex-shrink-0">
                        <Button
                            block
                            size="large"
                            type="primary"
                            icon={<RocketOutlined />}
                            className="!font-semibold !bg-[linear-gradient(90deg,var(--gradient-start),var(--gradient-end))] !border-none"
                        >
                            Activate Pro Version
                        </Button>
                    </div>
                )}
            </Sider>
            <Layout className="!bg-transparent transition-all duration-300 h-screen flex flex-col" style={{ marginLeft: collapsed ? 88 : 250 }}>
                <Header className="dashboard-header !px-6 flex justify-between items-center !h-20 !bg-color-bg-base !border-b !border-color-border" style={{ left: collapsed ? 88 : 250 }}>
                <div> <Button type="text" icon={collapsed ? <MenuUnfoldOutlined /> : <MenuFoldOutlined />} onClick={() => setCollapsed(!collapsed)} className="!h-10 !w-10 !text-xl !text-color-text-muted" /> </div>
                <div className="flex items-center gap-4">
                    <Dropdown dropdownRender={() => (
                        <Card className="w-80" bodyStyle={{ padding: 0 }}>
                            <div className="p-4 flex items-center justify-between border-b border-color-border"> <Text strong className="text-color-text-base">Notifications</Text> {unreadCount > 0 && <Button type="link" size="small" onClick={handleMarkAllAsRead}>Mark all as read</Button>} </div>
                            <div className="max-h-96 overflow-y-auto p-2 space-y-1">
                                {notifications.length > 0 ? (
                                    notifications.map(n => (
                                        <div key={n.id} onClick={() => handleNotificationClick(n)} className={`p-3 rounded-lg cursor-pointer transition-colors ${!n.read ? 'bg-color-primary/10' : 'hover:bg-color-ui-hover'}`}>
                                            <Space align="start">
                                                <Avatar icon={<UserOutlined />} className={!n.read ? '!bg-color-primary text-white' : ''} />
                                                <div> <Text strong className="block truncate text-color-text-base">{n.title}</Text> <Text className="text-xs line-clamp-2 text-color-text-muted">{n.message}</Text> </div>
                                                {!n.read && <div className="mt-1 w-2 h-2 bg-color-primary rounded-full flex-shrink-0" />}
                                            </Space>
                                        </div>
                                    ))
                                ) : ( <div className="text-center py-8 text-color-text-muted"><BellOutlined className="text-3xl mb-2 opacity-50" /><p>No new notifications</p></div> )}
                            </div>
                        </Card>
                     )} placement="bottomRight" arrow trigger={['click']}>
                        <Button shape="circle" icon={<Badge count={unreadCount} size="small"><BellOutlined /></Badge>} size="large" type="text" className="!text-color-text-muted" />
                    </Dropdown>
                    <Dropdown menu={{ onClick: handleUserMenuClick, items: (() => { const i = []; if (django_user_type === 'adminuser') { i.push({ key: '/dashboard/profile', label: 'Profile' }); } if (usertype === 'master') { i.push({ key: '/dashboard/settings', label: 'Settings' }); } i.push({ key: 'logout', label: 'Logout', danger: true }); return i; })() }} placement="bottomRight" arrow trigger={['click']} >
                        <Avatar size="large" icon={<UserOutlined />} className="cursor-pointer" />
                    </Dropdown>
                </div>
            </Header>

           <Content className="dashboard-content">
                 <div className="dashboard-content-wrapper">
                     {/* ==================== IMPROVED LAYOUT STRUCTURE ==================== */}
                     {/* Consistent content wrapper with proper spacing and responsive design */}
                     {/* ==================================================================== */}
                     {location.pathname === '/dashboard' ? (
                        <DashboardOverview />
                      ) : location.pathname === '/dashboard/profile' && django_user_type === 'adminuser' ? (
                        <UserDetail initialMobile={userMobile} />
                      ) : (
                        <Outlet context={{ userToApprove, onApprovalSuccess: handleApprovalSuccess, adminToApprove, onAdminApprovalSuccess: handleAdminApprovalSuccess }} />
                      )}
                 </div>
            </Content>
                {currentMeetingInvitation && ( <Modal title="Meeting Invitation" open={meetingInvitationModalVisible} onCancel={() => setMeetingInvitationModalVisible(false)} footer={[ <Button key="reject" danger onClick={() => handleMeetingResponse('rejected')} loading={meetingModalLoading}>Reject</Button>, <Button key="accept" type="primary" onClick={() => handleMeetingResponse('accepted')} loading={meetingModalLoading}>Accept</Button> ]} > <p>You have been invited to a meeting titled: <strong>{currentMeetingInvitation.title}</strong>.</p> <Text type="secondary">Do you want to accept or reject the invitation?</Text> </Modal> )}
                {notificationModal.visible && notificationModal.notification && (
                    <Modal open={notificationModal.visible} onCancel={() => setNotificationModal({visible: false})} title={<><BellOutlined /> Notification Details</>}
                      footer={[
                          <Button key="delete" danger icon={<DeleteOutlined />} onClick={async () => { if (notificationModal.notification) { await deleteNotification(notificationModal.notification.id); setNotificationModal({visible: false}); message.success('Notification deleted'); } }}>Delete</Button>,
                          (() => {
                            const hasLink = !!notificationModal.notification.link;
                            const isUserDetail = notificationModal.notification.data?.formType === 'userdetail' && django_user_type === 'projectadmin';
                            const isAdminDetail = notificationModal.notification.data?.formType === 'admindetail' && usertype === 'master';


                            const showButton = hasLink || isUserDetail || isAdminDetail;



                            return showButton;
                          })() && (
                              <Button key="view" type="primary" icon={<ArrowRightOutlined />} onClick={async () => {
                                  const notif = notificationModal.notification;
                                  if (!notif) return;

                                  console.log('ðŸŽ¯ View Details button clicked for notification:', {
                                    id: notif.id,
                                    type: notif.type,
                                    formType: notif.data?.formType,
                                    userId: notif.data?.userId,
                                    link: notif.link,
                                    data: notif.data
                                  });

                                  console.log('ðŸ” Current auth state before navigation:', {
                                    token: !!useAuthStore.getState().token,
                                    usertype: useAuthStore.getState().usertype,
                                    userId: useAuthStore.getState().userId,
                                    isAuthenticated: useAuthStore.getState().isAuthenticated()
                                  });

                                  setNotificationModal({visible: false});
                                  if (notif.data?.formType === 'userdetail' && django_user_type === 'projectadmin') {
                                    try {
                                        const res = await api.get('/authentication/userdetail/pending/');
                                        const userDetail = res.data.find((u: any) => u.user === notif.data?.userId);
                                        if (userDetail) {
                                            setUserToApprove(userDetail);
                                            navigate('/dashboard/profile');
                                        } else { message.info('User details no longer pending or could not be found.'); }
                                    } catch { message.error('Failed to load user details for approval.'); }
                                  } else if (notif.data?.formType === 'admindetail' && usertype === 'master') {
                                    try {
                                        console.log('ðŸ” Fetching admin details for approval, userId:', notif.data?.userId);
                                        const res = await api.get(`/authentication/admin/pending/${notif.data?.userId}/`);
                                        if (res.data) {
                                            console.log('âœ… Admin details fetched successfully:', res.data);
                                            // Store the admin data for approval in AdminDetail component
                                            setAdminToApprove(res.data);

                                            // Also store in sessionStorage as backup
                                            sessionStorage.setItem('adminToApprove', JSON.stringify(res.data));
                                            console.log('ðŸ“ Admin data set in state and sessionStorage, navigating to AdminDetail...');

                                            // Small delay to ensure state is updated before navigation
                                            setTimeout(() => {
                                                navigate('/dashboard/admindetail');
                                            }, 100);
                                        } else {
                                            console.log('âŒ No admin details returned from API');
                                            message.info('Admin details no longer pending or could not be found.');
                                        }
                                    } catch (error: any) {
                                        if (error.response?.status === 404) {
                                            const errorMsg = error.response?.data?.error || 'Admin details not found';
                                            if (errorMsg.includes('already approved')) {
                                                message.info('These admin details have already been approved.');
                                            } else if (errorMsg.includes('No admin details found')) {
                                                message.info('No admin details submitted for approval yet.');
                                            } else {
                                                message.info('Admin details no longer pending approval.');
                                            }
                                        } else {
                                            message.error('Failed to load admin details for approval.');
                                        }
                                    }
                                  } else if (notif.link) {
                                      console.log('ðŸš€ Navigating to notification link:', notif.link);
                                      const authState = useAuthStore.getState();
                                      console.log('ðŸ” Auth state just before navigation:', {
                                        token: !!authState.token,
                                        usertype: authState.usertype,
                                        userId: authState.userId,
                                        isAuthenticated: authState.isAuthenticated(),
                                        tokenExpiry: authState.tokenExpiry
                                      });

                                      // Check authentication before navigation
                                      if (!authState.token || !authState.isAuthenticated()) {
                                        console.log('ðŸš« Dashboard Notification: User not authenticated, skipping navigation');
                                        message.error('Please log in again to view this content.');
                                        return;
                                      }

                                      // Add a small delay to ensure modal is closed and state is stable
                                      setTimeout(() => {
                                        const currentAuthState = useAuthStore.getState();
                                        console.log('ðŸ” Auth state after timeout, before actual navigation:', {
                                          token: !!currentAuthState.token,
                                          usertype: currentAuthState.usertype,
                                          userId: currentAuthState.userId,
                                          isAuthenticated: currentAuthState.isAuthenticated()
                                        });

                                        // Double-check authentication after timeout
                                        if (currentAuthState.token && currentAuthState.isAuthenticated() && notif.link) {
                                          navigate(notif.link);
                                        } else {
                                          console.log('ðŸš« Auth state changed during timeout, skipping navigation');
                                          message.error('Authentication expired. Please log in again.');
                                        }
                                      }, 200);
                                  }
                              }}>View Details</Button>
                          ),

                          <Button key="close" onClick={() => setNotificationModal({visible: false})}>Close</Button>
                      ]}
                    >
                        <Title level={5}>{notificationModal.notification.title}</Title>
                        <Paragraph>{notificationModal.notification.message}</Paragraph>
                        <Divider style={{margin: '12px 0'}} />
                        <Text type="secondary"> <ClockCircleOutlined style={{marginRight: 8}}/> {new Date(notificationModal.notification.created_at).toLocaleString()} </Text>
                        {!notificationModal.notification.read && ( <Tag color="blue" style={{ marginLeft: 12 }}>New</Tag> )}
                    </Modal>
                )}
            </Layout>
        </Layout>
    );
};

export default Dashboard;
